{% set rig = show.rig_setup %}
<div class="tab-pane fade {% if active_tab == 'rig' %}show active{% endif %}" id="tab-rig">
  <div class="row">
    <div class="col-md-8">
      <form method="post" action="{{ url_for('show_details.update_rig', show_id=show.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3 d-flex gap-2">
          <a href="https://gdtf-share.com/" target="_blank" class="btn btn-gdtf">GDTF holen (Extern)</a>
          <a href="{{ url_for('main.gdtf_fixture_search') }}" class="btn btn-outline-info">GDTF Hersteller (Intern)</a>
        </div>
        <!-- Main Brand -->
        <div class="mb-3">
          <label class="form-label">Main Brand (Hausrig / Hauptmarke)</label>
          <select name="rig_main_brand" class="form-select form-select-sm"
            style="max-width:300px; min-width:180px; display:inline-block;">
            <option value="">– auswählen –</option>
            {% for m in manufacturers %}
            <option value="{{ m }}" {% if rig.main_brand==m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Spots Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-lightbulb-fill me-2"></i>Spots</h5>
            <button type="button" id="add-spot-row" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus-lg"></i> Reihe hinzufügen
            </button>
          </div>
          <div class="card-body">
            <div id="spots-rows">
              {% set items = rig.spots_items if rig and rig.spots_items is defined else None %}
              {% if items %}
              {% for it in items %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_spots__count[]" class="form-control form-control-sm"
                    value="{{ it.count }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_spots__manufacturer[]" class="form-select form-select-sm spots-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if it.manufacturer==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_spots__model[]" class="form-control form-control-sm spots-model"
                    value="{{ it.model }}" list="spots-model-list-{{ loop.index }}">
                  <datalist id="spots-model-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_spots__mode[]" class="form-control form-control-sm spots-mode"
                    value="{{ it.mode }}" list="spots-mode-list-{{ loop.index }}">
                  <datalist id="spots-mode-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_spots__universe[]" class="form-control form-control-sm"
                    value="{{ it.universe }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_spots__address[]" class="form-control form-control-sm"
                    value="{{ it.address }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_spots__watt[]" class="form-control form-control-sm"
                    value="{{ it.watt }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_spots__phase[]" class="form-control form-control-sm"
                    value="{{ it.phase }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_spots__count[]" class="form-control form-control-sm" value="">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_spots__manufacturer[]" class="form-select form-select-sm spots-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_spots__model[]" class="form-control form-control-sm spots-model" value=""
                    list="spots-model-list-0">
                  <datalist id="spots-model-list-0"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_spots__mode[]" class="form-control form-control-sm spots-mode" value=""
                    list="spots-mode-list-0">
                  <datalist id="spots-mode-list-0"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_spots__universe[]" class="form-control form-control-sm" value="">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_spots__address[]" class="form-control form-control-sm" value="">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_spots__watt[]" class="form-control form-control-sm" value="">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_spots__phase[]" class="form-control form-control-sm" value="">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endif %}
            </div>

            <div class="mt-3 d-flex gap-2">
              <a href="{{ url_for('main.gdtf_fixture_search') }}" class="btn btn-sm btn-outline-info" target="_blank">
                <i class="bi bi-search"></i> GDTF suchen
              </a>
            </div>
          </div>
        </div>

        <!-- Washes Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-droplet-fill me-2"></i>Washes</h5>
            <button type="button" id="add-wash-row" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus-lg"></i> Reihe hinzufügen
            </button>
          </div>
          <div class="card-body">
            <div id="washes-rows">
              {% set items = rig.washes_items if rig and rig.washes_items is defined else None %}
              {% if items %}
              {% for it in items %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_washes__count[]" class="form-control form-control-sm"
                    value="{{ it.count }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_washes__manufacturer[]" class="form-select form-select-sm washes-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if it.manufacturer==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_washes__model[]" class="form-control form-control-sm washes-model"
                    value="{{ it.model }}" list="washes-model-list-{{ loop.index }}">
                  <datalist id="washes-model-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_washes__mode[]" class="form-control form-control-sm washes-mode"
                    value="{{ it.mode }}" list="washes-mode-list-{{ loop.index }}">
                  <datalist id="washes-mode-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_washes__universe[]" class="form-control form-control-sm"
                    value="{{ it.universe }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_washes__address[]" class="form-control form-control-sm"
                    value="{{ it.address }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_washes__watt[]" class="form-control form-control-sm"
                    value="{{ it.watt }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_washes__phase[]" class="form-control form-control-sm"
                    value="{{ it.phase }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_washes__count[]" class="form-control form-control-sm"
                    value="{{ rig.washes or '' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_washes__manufacturer[]" class="form-select form-select-sm">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if rig.manufacturer_washes==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_washes__model[]" class="form-control form-control-sm washes-model"
                    value="" list="washes-model-list-0">
                  <datalist id="washes-model-list-0"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_washes__mode[]" class="form-control form-control-sm washes-mode" value=""
                    list="washes-mode-list-0">
                  <datalist id="washes-mode-list-0"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_washes__universe[]" class="form-control form-control-sm"
                    value="{{ rig.universe_washes or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_washes__address[]" class="form-control form-control-sm"
                    value="{{ rig.address_washes or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_washes__watt[]" class="form-control form-control-sm"
                    value="{{ rig.watt_washes or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_washes__phase[]" class="form-control form-control-sm"
                    value="{{ rig.phase_washes or '' }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endif %}
            </div>

            <div class="mt-3 d-flex gap-2">
              <a href="{{ url_for('main.gdtf_fixture_search') }}" class="btn btn-sm btn-outline-info" target="_blank">
                <i class="bi bi-search"></i> GDTF suchen
              </a>
            </div>
          </div>
        </div>

        <!-- Beams Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-bullseye me-2"></i>Beams</h5>
            <button type="button" id="add-beam-row" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus-lg"></i> Reihe hinzufügen
            </button>
          </div>
          <div class="card-body">
            <div id="beams-rows">
              {% set items = rig.beams_items if rig and rig.beams_items is defined else None %}
              {% if items %}
              {% for it in items %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_beams__count[]" class="form-control form-control-sm"
                    value="{{ it.count }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_beams__manufacturer[]" class="form-select form-select-sm beams-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if it.manufacturer==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_beams__model[]" class="form-control form-control-sm beams-model"
                    value="{{ it.model }}" list="beams-model-list-{{ loop.index }}">
                  <datalist id="beams-model-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_beams__mode[]" class="form-control form-control-sm beams-mode"
                    value="{{ it.mode }}" list="beams-mode-list-{{ loop.index }}">
                  <datalist id="beams-mode-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_beams__universe[]" class="form-control form-control-sm"
                    value="{{ it.universe }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_beams__address[]" class="form-control form-control-sm"
                    value="{{ it.address }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_beams__watt[]" class="form-control form-control-sm"
                    value="{{ it.watt }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_beams__phase[]" class="form-control form-control-sm"
                    value="{{ it.phase }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_beams__count[]" class="form-control form-control-sm"
                    value="{{ rig.beams or '' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_beams__manufacturer[]" class="form-select form-select-sm">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if rig.manufacturer_beams==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_beams__model[]" class="form-control form-control-sm beams-model" value=""
                    list="beams-model-list-0">
                  <datalist id="beams-model-list-0"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_beams__mode[]" class="form-control form-control-sm beams-mode" value=""
                    list="beams-mode-list-0">
                  <datalist id="beams-mode-list-0"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_beams__universe[]" class="form-control form-control-sm"
                    value="{{ rig.universe_beams or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_beams__address[]" class="form-control form-control-sm"
                    value="{{ rig.address_beams or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_beams__watt[]" class="form-control form-control-sm"
                    value="{{ rig.watt_beams or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_beams__phase[]" class="form-control form-control-sm"
                    value="{{ rig.phase_beams or '' }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endif %}
            </div>

            <div class="mt-3 d-flex gap-2">
              <a href="{{ url_for('main.gdtf_fixture_search') }}" class="btn btn-sm btn-outline-info" target="_blank">
                <i class="bi bi-search"></i> GDTF suchen
              </a>
            </div>
          </div>
        </div>

        <!-- Blinders Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-brightness-high me-2"></i>Blinders
            </h5>
            <button type="button" id="add-blinder-row" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus-lg"></i> Reihe hinzufügen
            </button>
          </div>
          <div class="card-body">
            <div id="blinders-rows">
              {% set items = rig.blinders_items if rig and rig.blinders_items is defined else None %}
              {% if items %}
              {% for it in items %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_blinders__count[]" class="form-control form-control-sm"
                    value="{{ it.count }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_blinders__manufacturer[]" class="form-select form-select-sm blinders-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if it.manufacturer==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_blinders__model[]" class="form-control form-control-sm blinders-model"
                    value="{{ it.model }}" list="blinders-model-list-{{ loop.index }}">
                  <datalist id="blinders-model-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_blinders__mode[]" class="form-control form-control-sm blinders-mode"
                    value="{{ it.mode }}" list="blinders-mode-list-{{ loop.index }}">
                  <datalist id="blinders-mode-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_blinders__universe[]" class="form-control form-control-sm"
                    value="{{ it.universe }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_blinders__address[]" class="form-control form-control-sm"
                    value="{{ it.address }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_blinders__watt[]" class="form-control form-control-sm"
                    value="{{ it.watt }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_blinders__phase[]" class="form-control form-control-sm"
                    value="{{ it.phase }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_blinders__count[]" class="form-control form-control-sm"
                    value="{{ rig.blinders or '' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_blinders__manufacturer[]" class="form-select form-select-sm">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if rig.manufacturer_blinders==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_blinders__model[]" class="form-control form-control-sm blinders-model"
                    value="" list="blinders-model-list-0">
                  <datalist id="blinders-model-list-0"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_blinders__mode[]" class="form-control form-control-sm blinders-mode"
                    value="" list="blinders-mode-list-0">
                  <datalist id="blinders-mode-list-0"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_blinders__universe[]" class="form-control form-control-sm"
                    value="{{ rig.universe_blinders or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_blinders__address[]" class="form-control form-control-sm"
                    value="{{ rig.address_blinders or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_blinders__watt[]" class="form-control form-control-sm"
                    value="{{ rig.watt_blinders or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_blinders__phase[]" class="form-control form-control-sm"
                    value="{{ rig.phase_blinders or '' }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endif %}
            </div>

            <div class="mt-3 d-flex gap-2">
              <a href="{{ url_for('main.gdtf_fixture_search') }}" class="btn btn-sm btn-outline-info" target="_blank">
                <i class="bi bi-search"></i> GDTF suchen
              </a>
            </div>
          </div>
        </div>


        <!-- Strobes Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-lightning-fill me-2"></i>Strobes
            </h5>
            <button type="button" id="add-strobe-row" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus-lg"></i> Reihe hinzufügen
            </button>
          </div>
          <div class="card-body">
            <div id="strobes-rows">
              {% set items = rig.strobes_items if rig and rig.strobes_items is defined else None %}
              {% if items %}
              {% for it in items %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_strobes__count[]" class="form-control form-control-sm"
                    value="{{ it.count }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_strobes__manufacturer[]" class="form-select form-select-sm strobes-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if it.manufacturer==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_strobes__model[]" class="form-control form-control-sm strobes-model"
                    value="{{ it.model }}" list="strobes-model-list-{{ loop.index }}">
                  <datalist id="strobes-model-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_strobes__mode[]" class="form-control form-control-sm strobes-mode"
                    value="{{ it.mode }}" list="strobes-mode-list-{{ loop.index }}">
                  <datalist id="strobes-mode-list-{{ loop.index }}"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_strobes__universe[]" class="form-control form-control-sm"
                    value="{{ it.universe }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_strobes__address[]" class="form-control form-control-sm"
                    value="{{ it.address }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_strobes__watt[]" class="form-control form-control-sm"
                    value="{{ it.watt }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_strobes__phase[]" class="form-control form-control-sm"
                    value="{{ it.phase }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="rig_strobes__count[]" class="form-control form-control-sm"
                    value="{{ rig.strobes or '' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <select name="rig_strobes__manufacturer[]" class="form-select form-select-sm strobes-manufacturer">
                    <option value="">–</option>
                    {% for m in manufacturers %}
                    <option value="{{ m }}" {% if rig.manufacturer_strobes==m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="rig_strobes__model[]" class="form-control form-control-sm strobes-model"
                    value="" list="strobes-model-list-0">
                  <datalist id="strobes-model-list-0"></datalist>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="rig_strobes__mode[]" class="form-control form-control-sm strobes-mode"
                    value="" list="strobes-mode-list-0">
                  <datalist id="strobes-mode-list-0"></datalist>
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="rig_strobes__universe[]" class="form-control form-control-sm"
                    value="{{ rig.universe_strobes or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="rig_strobes__address[]" class="form-control form-control-sm"
                    value="{{ rig.address_strobes or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="rig_strobes__watt[]" class="form-control form-control-sm"
                    value="{{ rig.watt_strobes or '' }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Phase</label>
                  <input type="text" name="rig_strobes__phase[]" class="form-control form-control-sm"
                    value="{{ rig.phase_strobes or '' }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endif %}
            </div>
            <div class="mt-3 d-flex gap-2">
              <a href="{{ url_for('main.gdtf_fixture_search') }}" class="btn btn-sm btn-outline-info" target="_blank">
                <i class="bi bi-search"></i> GDTF suchen
              </a>
            </div>
          </div>
        </div>

        <!-- Custom Devices Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-tools me-2"></i>Weitere Lampen /
              Custom Devices</h5>
            <button type="button" id="add-custom-device-row" class="btn btn-sm btn-outline-success">
              <i class="bi bi-plus-lg"></i> Lampe hinzufügen
            </button>
          </div>
          <div class="card-body">
            <div id="custom-devices-rows">
              {% set custom_items = rig.custom_devices if rig and rig.custom_devices is defined else None %}
              {% if custom_items and custom_items|length > 0 %}
              {% for it in custom_items %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="custom_devices__count[]" class="form-control form-control-sm"
                    value="{{ it.count }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Name/Typ</label>
                  <input type="text" name="custom_devices__name[]" class="form-control form-control-sm"
                    value="{{ it.name }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <input type="text" name="custom_devices__manufacturer[]" class="form-control form-control-sm"
                    value="{{ it.manufacturer }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="custom_devices__model[]" class="form-control form-control-sm"
                    value="{{ it.model }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="custom_devices__mode[]" class="form-control form-control-sm"
                    value="{{ it.mode }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="custom_devices__universe[]" class="form-control form-control-sm"
                    value="{{ it.universe }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="custom_devices__address[]" class="form-control form-control-sm"
                    value="{{ it.address }}">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="custom_devices__watt[]" class="form-control form-control-sm"
                    value="{{ it.watt }}">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="row mb-2 rig-item-row align-items-end">
                <div class="col-md-1">
                  <label class="form-label small text-muted">Anzahl</label>
                  <input type="text" name="custom_devices__count[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Name/Typ</label>
                  <input type="text" name="custom_devices__name[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Hersteller</label>
                  <input type="text" name="custom_devices__manufacturer[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted">Modell</label>
                  <input type="text" name="custom_devices__model[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Mode</label>
                  <input type="text" name="custom_devices__mode[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Uni</label>
                  <input type="text" name="custom_devices__universe[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Addr</label>
                  <input type="text" name="custom_devices__address[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-1">
                  <label class="form-label small text-muted">Watt</label>
                  <input type="text" name="custom_devices__watt[]" class="form-control form-control-sm">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row w-100" title="Entfernen"><i
                      class="bi bi-trash"></i></button>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Notizen & Hinweise Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i class="bi bi-journal-text me-2"></i>Notizen &
              Hinweise</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label text-muted small">Positionen / Hinweise</label>
              <textarea name="rig_positions" rows="2"
                class="form-control form-control-sm text-bg-dark border-secondary">{{ rig.positions or '' }}</textarea>
            </div>
            <div class="mb-0">
              <label class="form-label text-muted small">Rig-Notizen</label>
              <textarea name="rig_notes" rows="2"
                class="form-control form-control-sm text-bg-dark border-secondary">{{ rig.notes or '' }}</textarea>
            </div>
          </div>
        </div>

        <!-- Strom Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50"><i
                class="bi bi-lightning-charge-fill me-2"></i>Strom
            </h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label text-muted small">Main</label>
                <input type="text" name="rig_power_main" class="form-control form-control-sm"
                  value="{{ rig.power_main or '' }}">
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Light</label>
                <input type="text" name="rig_power_light" class="form-control form-control-sm"
                  value="{{ rig.power_light or '' }}">
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Sound</label>
                <input type="text" name="rig_power_sound" class="form-control form-control-sm"
                  value="{{ rig.power_sound or '' }}">
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label text-muted small">Video</label>
                <input type="text" name="rig_power_video" class="form-control form-control-sm"
                  value="{{ rig.power_video or '' }}">
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">FOH</label>
                <input type="text" name="rig_power_foh" class="form-control form-control-sm"
                  value="{{ rig.power_foh or '' }}">
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Sonstiges</label>
                <input type="text" name="rig_power_other" class="form-control form-control-sm"
                  value="{{ rig.power_other or '' }}">
              </div>
            </div>
          </div>
        </div>

        <!-- DMX-Adress-Übersicht Card -->
        <div class="card mb-4 border-secondary bg-dark text-light">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <h5 class="h6 mb-0 text-uppercase fw-bold text-white-50">
              <i class="bi bi-diagram-3 me-2"></i>DMX-Adress-Übersicht
            </h5>
            <button type="button" id="refresh-dmx-overview" class="btn btn-sm btn-outline-info">
              <i class="bi bi-arrow-clockwise"></i> Aktualisieren
            </button>
          </div>
          <div class="card-body">
            <div id="dmx-overview-container">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label text-muted small">Universe filtern</label>
                  <select id="dmx-universe-filter" class="form-select form-select-sm">
                    <option value="">Alle Universen</option>
                    <option value="1">Universe 1</option>
                    <option value="2">Universe 2</option>
                    <option value="3">Universe 3</option>
                    <option value="4">Universe 4</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <div id="dmx-stats" class="text-end pt-4">
                    <span class="text-muted small">Klicke "Aktualisieren" für DMX-Übersicht</span>
                  </div>
                </div>
              </div>
              <div id="dmx-grid" class="d-flex flex-wrap gap-1 mb-3" style="font-size: 0.65rem;">
                <!-- DMX-Adressen werden hier dynamisch gerendert -->
              </div>
              <div class="d-flex gap-3 small">
                <span><span class="badge bg-success me-1">&nbsp;</span> Belegt</span>
                <span><span class="badge bg-secondary me-1">&nbsp;</span> Frei</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 mb-3">
          <button type="submit" class="btn btn-primary w-100 py-2 fw-bold text-uppercase"
            style="letter-spacing: 0.05em;">
            <i class="bi bi-save me-2"></i>Rig &amp; Strom speichern
          </button>
        </div>
      </form>

      <!-- Power summary -->
      {% if rig_power_summary %}
      <div class="alert alert-secondary small mt-3 border-secondary bg-dark text-light">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-info-circle-fill me-2 text-info"></i>
          <strong class="text-uppercase text-white-50">Strom-Zusammenfassung</strong>
        </div>

        {% if rig_power_summary.total_watt %}
        <div class="mb-1">
          <span class="text-muted">Geschätzte Lichtleistung:</span>
          <span class="fw-bold text-light ms-2">{{ rig_power_summary.total_watt|int }} W</span>
          <span class="text-white-50 ms-1">(≈ {{ '%.2f'|format(rig_power_summary.total_kw) }} kW)</span>
        </div>
        {% endif %}

        {% if rig_power_summary.apparent_kva %}
        <div class="mb-1">
          <span class="text-muted">Scheinleistung (cos φ ≈ {{ rig_power_summary.cos_phi }}):</span>
          <span class="fw-bold text-info ms-2">{{ '%.2f'|format(rig_power_summary.apparent_kva) }} kVA</span>
        </div>
        {% endif %}

        {% if rig_power_summary.current_1ph %}
        <div class="mb-1">
          <span class="text-muted">Strom (1-Phase / 230V):</span>
          <span class="fw-bold text-light ms-2"> ~ {{ '%.1f'|format(rig_power_summary.current_1ph) }} A</span>
        </div>
        {% endif %}

        {% if rig_power_summary.current_3ph %}
        <div>
          <span class="text-muted">Strom (3-Phase / 400V):</span>
          <span class="fw-bold text-light ms-2"> ~ {{ '%.1f'|format(rig_power_summary.current_3ph) }} A</span>
          <span class="text-white-50 small">je Phase</span>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <script>
        // GDTF API: Modelle für Hersteller laden
        async function fetchGdtfModels(manufacturer) {
          if (!manufacturer) return [];
          try {
            const resp = await fetch(`/api/gdtf/fixtures/${encodeURIComponent(manufacturer)}`);
            if (!resp.ok) return [];
            const data = await resp.json();
            return data.models || [];
          } catch (e) {
            console.warn('[GDTF] Fehler beim Laden:', e);
            return [];
          }
        }

        async function updateModelOptions(row, type) {
          const manuSel = row.querySelector('.' + type + '-manufacturer');
          const modelInput = row.querySelector('.' + type + '-model');
          const modelList = row.querySelector('datalist[id^="' + type + '-model-list"]');
          const modeInput = row.querySelector('.' + type + '-mode');
          const modeList = row.querySelector('datalist[id^="' + type + '-mode-list"]');
          if (!manuSel || !modelInput || !modelList || !modeInput || !modeList) return;
          const manu = manuSel.value;
          // Modelle setzen
          modelList.innerHTML = '';
          // Check if LAMP_MODELS exists (it should be defined globally or in another script)
          if (typeof LAMP_MODELS !== 'undefined' && LAMP_MODELS[manu]) {
            Object.keys(LAMP_MODELS[manu]).forEach(function (model) {
              const opt = document.createElement('option');
              opt.value = model;
              modelList.appendChild(opt);
            });
          }

          // GDTF API im Hintergrund abfragen
          if (manu) {
            // Loading-Indicator
            modelInput.placeholder = 'Lade GDTF...';
            const gdtfModels = await fetchGdtfModels(manu);
            modelInput.placeholder = '';

            if (gdtfModels.length > 0) {
              // Bestehende Optionen sammeln
              const existing = new Set();
              modelList.querySelectorAll('option').forEach(o => existing.add(o.value));

              // Neue GDTF-Modelle hinzufügen
              gdtfModels.forEach(function (model) {
                if (!existing.has(model)) {
                  const opt = document.createElement('option');
                  opt.value = model;
                  opt.textContent = model + ' (GDTF)';
                  modelList.appendChild(opt);
                }
              });
              console.log(`[GDTF] ${gdtfModels.length} Modelle für ${manu} geladen`);
            }
          }
        }
        // GDTF API: Modes für ein Fixture laden
        async function fetchGdtfModes(manufacturer, fixtureName) {
          if (!manufacturer || !fixtureName) return [];
          try {
            const resp = await fetch(`/api/gdtf/modes/${encodeURIComponent(manufacturer)}/${encodeURIComponent(fixtureName)}`);
            if (!resp.ok) return [];
            const data = await resp.json();
            return data.modes || [];
          } catch (e) {
            console.warn('[GDTF] Fehler beim Mode-Laden:', e);
            return [];
          }
        }

        async function updateModeOptions(row, type) {
          const manuSel = row.querySelector('.' + type + '-manufacturer');
          const modelInput = row.querySelector('.' + type + '-model');
          const modeInput = row.querySelector('.' + type + '-mode');
          const modeList = row.querySelector('datalist[id^="' + type + '-mode-list"]');
          if (!manuSel || !modelInput || !modeInput || !modeList) return;
          const manu = manuSel.value;
          const model = modelInput.value;
          modeList.innerHTML = '';

          // Lokale Modes zuerst (falls vorhanden)
          if (typeof LAMP_MODELS !== 'undefined' && LAMP_MODELS[manu] && LAMP_MODELS[manu][model]) {
            LAMP_MODELS[manu][model].forEach(function (mode) {
              const opt = document.createElement('option');
              opt.value = mode;
              modeList.appendChild(opt);
            });
          }

          // GDTF Modes laden
          if (manu && model) {
            modeInput.placeholder = 'Lade Modes...';
            const gdtfModes = await fetchGdtfModes(manu, model);
            modeInput.placeholder = '';

            if (gdtfModes.length > 0) {
              const existing = new Set();
              modeList.querySelectorAll('option').forEach(o => existing.add(o.value));

              gdtfModes.forEach(function (mode) {
                const modeName = mode.name || mode;
                const footprint = mode.dmx_footprint || 0;
                if (!existing.has(modeName)) {
                  const opt = document.createElement('option');
                  opt.value = modeName;
                  opt.textContent = footprint ? `${modeName} (${footprint} CH)` : modeName;
                  opt.dataset.footprint = footprint; // Footprint speichern
                  modeList.appendChild(opt);
                }
              });
              console.log(`[GDTF] ${gdtfModes.length} Modes für ${model} geladen`);
            }
          }
        }

        // --- DMX ÜBERSICHT LOGIK ---
        function renderDmxOverview() {
          const grid = document.getElementById('dmx-grid');
          const stats = document.getElementById('dmx-stats');
          const uniFilter = document.getElementById('dmx-universe-filter').value;
          if (!grid) return;

          grid.innerHTML = '';
          const occupied = new Set();

          // Alle Reihen durchgehen und belegte Adressen sammeln
          document.querySelectorAll('.rig-item-row').forEach(row => {
            const uni = row.querySelector('input[name*="__universe"], .spots-universe, .washes-universe, .beams-universe, .blinders-universe, .strobes-universe')?.value;
            const addr = parseInt(row.querySelector('input[name*="__address"], .spots-address, .washes-address, .beams-address, .blinders-address, .strobes-address')?.value);
            const modeVal = row.querySelector('input[name*="__mode"], .spots-mode, .washes-mode, .beams-mode, .blinders-mode, .strobes-mode')?.value;

            if (!uni || isNaN(addr) || addr < 1) return;
            if (uniFilter && uni !== uniFilter) return;

            // Footprint ermitteln (Versuch aus Mode-String zu extrahieren oder Dummy)
            let footprint = 1;
            const fpMatch = modeVal?.match(/\((\d+)\s*CH\)/i);
            if (fpMatch) {
              footprint = parseInt(fpMatch[1]);
            } else {
              // Fallback: Wenn wir den Mode-String nicht parsen können, schauen wir ob wir's aus der Datalist finden
              const listId = row.querySelector('input[name*="__mode"]')?.getAttribute('list');
              if (listId) {
                const opt = document.querySelector(`#${listId} option[value="${modeVal}"]`);
                if (opt && opt.dataset.footprint) footprint = parseInt(opt.dataset.footprint);
              }
            }

            for (let i = 0; i < footprint; i++) {
              if (addr + i <= 512) {
                occupied.add(`${uni}-${addr + i}`);
              }
            }
          });

          // Grid rendern (nur für das gewählte Universum oder Standard Uni 1)
          const activeUni = uniFilter || "1";
          for (let i = 1; i <= 512; i++) {
            const cell = document.createElement('div');
            cell.style.width = '12px';
            cell.style.height = '12px';
            cell.style.border = '1px solid #444';
            cell.title = `Addr ${i}`;

            if (occupied.has(`${activeUni}-${i}`)) {
              cell.className = 'bg-success';
              cell.title += ' (BELEGT)';
            } else {
              cell.className = 'bg-secondary opacity-25';
            }
            grid.appendChild(cell);
          }

          if (stats) {
            const count = Array.from(occupied).filter(key => key.startsWith(`${activeUni}-`)).length;
            stats.innerHTML = `<span class="badge bg-info">Uni ${activeUni}: ${count} / 512 belegt</span>`;
          }
        }
        function setupLampDropdowns(type) {
          document.querySelectorAll('#' + type + '-rows .rig-item-row').forEach(function (row) {
            const manuSel = row.querySelector('.' + type + '-manufacturer');
            const modelSel = row.querySelector('.' + type + '-model');
            const modeSel = row.querySelector('.' + type + '-mode');
            if (!manuSel || !modelSel || !modeSel) return;
            manuSel.addEventListener('change', function () {
              updateModelOptions(row, type);
              updateModeOptions(row, type);
            });
            modelSel.addEventListener('change', function () {
              updateModeOptions(row, type);
            });
          });
        }
        document.addEventListener('DOMContentLoaded', function () {
          setupLampDropdowns('spots');
          setupLampDropdowns('washes');
          setupLampDropdowns('beams');
          setupLampDropdowns('blinders');
          setupLampDropdowns('strobes');

          // DMX Overview Handler
          const refreshBtn = document.getElementById('refresh-dmx-overview');
          if (refreshBtn) refreshBtn.addEventListener('click', renderDmxOverview);

          const uniFilter = document.getElementById('dmx-universe-filter');
          if (uniFilter) uniFilter.addEventListener('change', renderDmxOverview);

          // Auto-Update bei Adressänderungen
          document.addEventListener('change', function (e) {
            if (e.target.name && (e.target.name.includes('address') || e.target.name.includes('universe') || e.target.name.includes('mode'))) {
              renderDmxOverview();
            }
          });

          // Initial render
          setTimeout(renderDmxOverview, 1000);
        });
        function makeAddHandler(addButtonId, containerId) {
          const addBtn = document.getElementById(addButtonId);
          const container = document.getElementById(containerId);
          if (!addBtn || !container) return;
          // Remove any previous click handlers by cloning the node
          const newAddBtn = addBtn.cloneNode(true);
          addBtn.parentNode.replaceChild(newAddBtn, addBtn);
          newAddBtn.addEventListener('click', function () {
            const first = container.querySelector('.rig-item-row');
            if (!first) return;
            const clone = first.cloneNode(true);
            // clear inputs
            clone.querySelectorAll('input').forEach(i => i.value = '');
            clone.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            container.appendChild(clone);
          });
        }
        document.addEventListener('click', function (e) {
          if (e.target && e.target.classList.contains('remove-row')) {
            const row = e.target.closest('.rig-item-row');
            if (!row) return;
            const container = row.parentElement;
            // Don't remove if it's the last row
            if (container.querySelectorAll('.rig-item-row').length <= 1) {
              // just clear fields
              row.querySelectorAll('input').forEach(i => i.value = '');
              row.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            } else {
              row.remove();
            }
          }
        });
        makeAddHandler('add-spot-row', 'spots-rows');
        makeAddHandler('add-wash-row', 'washes-rows');
        makeAddHandler('add-beam-row', 'beams-rows');
        makeAddHandler('add-blinder-row', 'blinders-rows');
        makeAddHandler('add-strobe-row', 'strobes-rows');
        makeAddHandler('add-custom-device-row', 'custom-devices-rows');
      </script>

    </div> <!-- End of col-md-8 -->

    <!-- Checklisten-Spalte (Right Column) -->
    <div class="col-md-4" id="checklists">
      <div class="sticky-top" style="top: 1rem; z-index: 10;">
        {% include "partials/checklists_block.html" ignore missing %}
      </div>
    </div>

  </div> <!-- End of row -->
</div> <!-- End of tab-pane -->